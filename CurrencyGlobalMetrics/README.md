## CurrencyGlobalMetrics
![avatar](/dags/transactional_activity/img/avatar.jpg)

---
#### О проекте:  
Проект реализует ETL-процесс для анализа данных о транзакциях между клиентами в различных валютах.  
Источник данных:  
База данных PostgreSQL, содержащая следующие таблицы:  
transactions — информация о движении денежных средств между клиентами (дата, сумма, валюта, отправитель, получатель и т.д.)  
currencies — справочник с данными об обновлениях курсов валют и валютных парах.  
Оркестрация:  
Процесс выгрузки и трансформации данных оркестрируется с помощью Apache Airflow.  
Ежедневно запускается DAG, который:  
Выгружает батч данных за предыдущий день из таблиц transactions и currencies.  
Выполняет трансформацию и агрегацию данных.  
Формирует витрину данных global_metrics.  
Витрина global_metrics:  
Представляет собой агрегированные и готовые к анализу данные, позволяющие отвечать на ключевые бизнес-вопросы:  
- Ежедневная динамика сумм переводов в разных валютах   
- Среднее количество транзакций на одного пользователя    
- Сколько уникальных пользователей совершают транзакции в каждой валюте  
- Общий оборот компании, пересчитанный в единую валюту     

---
#### Структура проекта  
```
.
├── dags                 # DAG.
├       ── transactional_activity    # Основная папка с проектом.
├           ── configs               # Конфигурационные параметры.
├           ── img                   # Изображения.
├           ── libs                  # Вспомогательные библиотеки.
├           ── sql                   # SQL запросы для инициализации таблиц.
├           ── utils                 # Утилиты.
├               ── tmp_data          # Временные файлы.
├── global_metrics.py                # Dag - Основная логика работы пайплайна.
├── plugins                          # Драйвера и сертификаты.
├── .gitignore                       # Список файлов игнорируемых системой контроля версий.
├── docker-compose.yaml              # Конфигурация сервисов.
├── README.md                        # Документация.
└── requirements.txt                 # Зависимости проекта.
```
---

#### Настройка кофигурационного файла  
В файле /dags/transactional_activity/configs/config.json - необходимо задать параметры подключения к базам данных и дополнительные конфигурационные параметры.
```
{
    "postgres_conn": { <---- Параметры подключения к Postgres
        "database": "", <---- База данных
        "host": "", <---- Хост
        "port": , <---- Порт
        "username": "", <---- Имя пользователя
        "password": "", <---- Пароль
        "batch_size": , <---- Размер батча
        "pg_table_transactions": { <---- Таблица источник
            "schema_name": "", <---- Схема
            "table_name": "", <---- Таблица 
            "dt_load_column": "", <---- Поле с датой загрузки
            "pk_column": "" <---- Поле первичный ключ
        },
        "pg_table_currencies": {
            "schema_name": "",
            "table_name": "",
            "dt_load_column": ""
        }
    },
    "vertica_conn": { <---- Параметры подключения к Vertica
        "database": "", <---- База данных
        "host": "", <---- Хост
        "port": , <---- Порт
        "username": "", <---- Имя пользователя
        "password": "", <---- Пароль
        "vertica_table_transactions": {
            "schema_name": "",
            "table_name": ""
        },
        "vertica_table_currencies": {
            "schema_name": "",
            "table_name": ""
        },
        "vertica_table_global_metrics": {
            "schema_name": "",
            "table_name": ""
        }
    }
}
```
---
Выполняем запуск сервисов при помощи docker-compose.yml  
```
docker-compose up -d
```
Airflow доступен по адресу http://localhost:8080  
![airflow_main_page](/dags/transactional_activity/img/airflow_main_page.png)
![airflow_graph](/dags/transactional_activity/img/airflow_graph.png)

Если перевести DAG в рабочий режим, он будет автоматически запускаться каждый день в 01:00. В рамках этого запуска DAG выбирает данные за предыдущий день и формирует витрину GlobalMetrics.